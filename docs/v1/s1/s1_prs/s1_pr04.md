# agency slice 01 — pr-04 spec: run pipeline skeleton (internal API)

## goal

introduce a stable internal integration seam for slice 01 by defining a `RunPipeline` orchestrator that executes named steps in order, short-circuits on first error, and preserves `AgencyError` codes—without implementing worktrees, setup execution, tmux, or CLI wiring in this PR.

---

## scope

### in-scope

- define a single internal orchestrator function:

  ```go
  func RunPipeline(ctx context.Context, opts RunPipelineOpts) (runID string, err error)

	•	define RunPipelineOpts containing only the inputs needed by slice 01:

type RunPipelineOpts struct {
  Title  string // may be empty => later PR applies default
  Runner string // may be empty => later PR applies default from agency.json
  Parent string // may be empty => later PR applies default from agency.json
  Attach bool   // later PR uses this; pipeline stores it but does not attach here
}


	•	define the step ordering and required semantics:
	1.	CheckRepoSafe (from PR-02)
	2.	LoadAgencyConfig (from PR-03)
	3.	CreateWorktree (stub in this PR; implemented in PR-05)
	4.	WriteMeta (stub in this PR; implemented in PR-06)
	5.	RunSetup (stub in this PR; implemented in PR-07)
	6.	StartTmux (stub in this PR; implemented in PR-08)
	•	establish a single in-memory “pipeline context” struct passed between steps (internal only) that accumulates:
	•	RepoContext (repo_root, repo_id, origin_url)
	•	resolved config (AgencyConfig)
	•	computed runtime values (run_id, title, branch, worktree_path, runner_cmd, parent_branch)
	•	provide default “not implemented” behavior for unimplemented steps:
	•	steps CreateWorktree, WriteMeta, RunSetup, StartTmux must return an AgencyError with code E_NOT_IMPLEMENTED
	•	include a details field naming the missing step (e.g. "step=CreateWorktree")
	•	implement strict short-circuit semantics:
	•	if any step returns an error, no subsequent steps run
	•	if the error is an AgencyError, preserve its code/message/details exactly
	•	if the error is not an AgencyError, wrap it into AgencyError with code E_INTERNAL

out-of-scope
	•	no CLI commands or flag parsing
	•	no git worktree operations
	•	no script execution
	•	no tmux operations
	•	do not change PR-02 or PR-03 behavior beyond what is required to call them
	•	do not add persistence formats or write any files

⸻

public surface area added/changed

internal api
	•	RunPipeline(ctx, opts) and supporting internal types in the pipeline package/module

no other exported APIs.

⸻

error codes

this PR introduces one new error code:
	•	E_NOT_IMPLEMENTED — returned by placeholder steps until later PRs implement them

also uses existing code:
	•	E_INTERNAL — for unexpected errors (must already exist from PR-01; if not, add it there, not here)

guardrail: do not introduce any additional error codes.

⸻

behavioral contract (given/when/then)

1) short-circuit preserves error codes

given
	•	CheckRepoSafe returns AgencyError{Code: E_PARENT_DIRTY, ...}

when
	•	RunPipeline(ctx, opts) is called

then
	•	RunPipeline returns that error (code preserved)
	•	LoadAgencyConfig and later steps are not called

⸻

2) success through implemented steps reaches first stub and returns not implemented

given
	•	CheckRepoSafe succeeds
	•	LoadAgencyConfig succeeds

when
	•	RunPipeline(ctx, opts) is called

then
	•	RunPipeline returns E_NOT_IMPLEMENTED with details indicating CreateWorktree
	•	WriteMeta, RunSetup, StartTmux are not called

⸻

3) non-agency errors are wrapped

given
	•	a step returns a non-AgencyError error (e.g. errors.New("boom"))

when
	•	RunPipeline(...)

then
	•	returned error is an AgencyError with:
	•	code = E_INTERNAL
	•	cause populated (or message includes original error)
	•	details include which step failed

⸻

implementation requirements

step interface

use a small internal step abstraction (do not over-engineer):

type pipelineStep func(ctx context.Context, st *pipelineState) error

where pipelineState is internal and includes:
	•	input opts
	•	repo ctx
	•	config
	•	derived fields

minimal state derivation in this PR
	•	RunPipeline must generate a run_id immediately (from PR-01 helper) and store it in state.
	•	do not apply defaults for title/parent/runner in this PR; later PR (PR-09) will handle CLI defaults. pipeline may carry empty strings.
	•	after LoadAgencyConfig, store:
	•	state.ResolvedRunnerCmd = cfg.RunnerCmd
	•	state.SetupScript = cfg.SetupScript

no file paths are computed here beyond what the called functions need.

⸻

tests

unit tests (required)

write unit tests for RunPipeline using dependency injection to avoid invoking git or filesystem.

required approach:
	•	RunPipeline must allow swapping step functions in tests (e.g. package-level vars or a constructor returning a pipeline instance).
	•	tests must not call real CheckRepoSafe or real LoadAgencyConfig.

test cases:
	1.	short-circuit on first step error

	•	first step returns AgencyError{Code: "E_PARENT_DIRTY"}
	•	assert subsequent steps not called
	•	assert returned code preserved

	2.	reaches CreateWorktree stub and returns E_NOT_IMPLEMENTED

	•	first two steps succeed
	•	third step is default stub returning E_NOT_IMPLEMENTED with detail step=CreateWorktree
	•	assert returned code and detail

	3.	wrap non-agency error into E_INTERNAL

	•	a step returns errors.New("boom")
	•	assert returned error is AgencyError with E_INTERNAL and includes the step name in details

guardrails for tests
	•	no integration tests in this PR
	•	no temp git repos
	•	no tmux

⸻

guardrails
	•	keep it minimal: do not introduce frameworks or complex DI containers
	•	no new third-party dependencies
	•	no persistence
	•	no “retry” logic
	•	do not silently skip steps; step order is fixed

⸻

definition of done
	•	RunPipeline exists, runs steps in fixed order, and short-circuits correctly
	•	unimplemented steps return E_NOT_IMPLEMENTED with step name detail
	•	unit tests cover the three required behaviors
	•	go test ./... passes
