# PR Spec: Professional Release & Distribution (v0.1.0)

## Goal

Ship a **professional, reproducible, and ergonomic v0.1.0 release** of `agency` with:
- deterministic versioning
- GitHub Releases via GoReleaser
- Homebrew tap distribution (macOS + brew-on-linux)
- automatic installation of bash/zsh completions via Homebrew
- manual completion enablement for non-brew installs

This PR focuses on **release plumbing**, not feature changes.

---

## Non-Goals (Explicit)

This PR does **not**:
- add Linux distro repositories (apt/yum/pacman)
- submit to `homebrew/core`
- add fish completions
- add artifact signing (GPG/Sigstore)
- change CLI behavior, flags, or storage semantics
- modify tab-completion behavior beyond packaging/installation

---

## Versioning

### Release Version
- Target version: **v0.1.0**
- Tag format: `vX.Y.Z`
- Release trigger: **git tag push**

### Version Injection
- `agency --version` must print:
```

agency v0.1.0 (commit <shortsha>)

```
- Version and commit injected via GoReleaser `ldflags`
- No `dev` version allowed in release artifacts

---

## Distribution Targets (v1)

### Platforms
- `darwin/arm64`
- `darwin/amd64`
- `linux/amd64`
- (linux/arm64 deferred)

### Install Methods

| Method | Binary | Completions |
|--------|--------|-------------|
| Homebrew Tap | ✓ auto | ✓ auto |
| GitHub Releases (tar.gz) | ✓ manual | ✓ manual |
| `go install` | ✓ auto | ✗ manual |

- **Homebrew**: `brew install NielsdaWheelz/tap/agency` — installs binary + completions
- **GitHub Releases**: download tarball, extract, add to PATH, manually enable completions
- **`go install`**: installs binary only; users must manually enable completions via `agency completion bash|zsh`

Linux distro packages (`.deb/.rpm`) are **deferred**.

---

## Shell Completion Distribution

### Supported Shells (v1)
- bash
- zsh

### Generation (Source of Truth)
- Completion scripts are **generated during release** using `go run` (not the built binary):
```bash
go run ./cmd/agency completion bash > completions/agency.bash
go run ./cmd/agency completion zsh > completions/_agency
```
- Generation happens in GoReleaser `before.hooks` (pre-build)
- Uses `go run` to avoid PATH issues — completion generation doesn't depend on ldflags
- Output must be deterministic (no timestamps, no machine paths)

### Archive Contents
Each release archive must include:
```
agency_0.1.0_darwin_arm64/
├── agency
├── README.md
├── LICENSE
└── completions/
    ├── agency.bash
    └── _agency
```

The `completions/` directory structure is required — Homebrew formula paths depend on it.

---

## Homebrew Distribution

### Tap
- Repository: `NielsdaWheelz/homebrew-tap`
- Formula path: `Formula/agency.rb`
- Managed automatically by GoReleaser

### Formula Requirements
- Installs binary:
```

bin.install "agency"

```
- Installs completions:
```

bash_completion.install "completions/agency.bash" => "agency"
zsh_completion.install "completions/_agency"

```
- Test block:
```

system "#{bin}/agency", "--version"

```

### UX Notes
- Homebrew installs completion files automatically
- Users may need:
  - Shell restart (or `source ~/.bashrc` / `source ~/.zshrc`)
  - Standard shell completion setup (`compinit` for zsh, bash-completion sourced for bash)
- On Linux (Homebrew on Linux), completion auto-loading is less consistent than macOS; document manual steps as fallback

---

## GoReleaser Changes

### Pre-Build Hooks (`before.hooks`)
```yaml
before:
  hooks:
    - go mod tidy
    - go test ./...
    - mkdir -p completions
    - go run ./cmd/agency completion bash > completions/agency.bash
    - go run ./cmd/agency completion zsh > completions/_agency
```

**Critical**: Use `go run ./cmd/agency` (not `agency`) to avoid PATH issues in CI.

### Archives
```yaml
archives:
  - files:
      - README.md
      - LICENSE
      - completions/*
```

### Brews
```yaml
brews:
  - name: agency
    repository:
      owner: NielsdaWheelz
      name: homebrew-tap
      token: "{{ .Env.HOMEBREW_TAP_GITHUB_TOKEN }}"
    install: |
      bin.install "agency"
      bash_completion.install "completions/agency.bash" => "agency"
      zsh_completion.install "completions/_agency"
    test: |
      system "#{bin}/agency", "--version"
```

---

## GitHub Actions: Release Workflow

### Trigger
- On tag push matching `v*`

### Steps
1. Checkout
2. Setup Go
3. Run `go test ./...`
4. Run GoReleaser (release mode)

### Secrets
- `HOMEBREW_TAP_TOKEN` (PAT with write access to tap repo)

---

## Release Notes

GitHub Release includes autogenerated changelog via GoReleaser (`changelog:` section).

Minimal release notes template:
```markdown
## agency v0.1.0

Initial public release.

### Installation
- Homebrew: `brew install NielsdaWheelz/tap/agency`
- Binary: download from assets below

See README for full documentation.
```

---

## CI Preflight (Recommended)

Before tagging a release, validate locally:
```bash
goreleaser release --snapshot --skip=publish --clean
```

Verify:
- [ ] Archives contain `completions/agency.bash` and `completions/_agency`
- [ ] `agency --version` in built binary shows correct version
- [ ] No errors in goreleaser output

This catches 80% of release failures before they hit CI.

---

## Documentation Updates

### README Changes
- Installation via GitHub Releases
- Installation via Homebrew
- Enabling shell completions (bash/zsh) — both auto (brew) and manual paths
- Link to `docs/install.md` (optional, for detailed instructions)

### Add `docs/releasing.md`
- How to cut a release (tag and push)
- Required secrets (`HOMEBREW_TAP_GITHUB_TOKEN`)
- Pre-release verification checklist
- Post-release verification checklist

---

## Constraints & Invariants

- No changes to CLI semantics
- No changes to completion logic (only distribution/packaging)
- Release artifacts must be **deterministically generated within a release** (no environment-specific paths or timestamps)
- Completion generation must be read-only and fast
- Homebrew install must succeed from a clean system
- Version is exposed via `agency --version` only (no `agency version` subcommand)

---

## Acceptance Criteria

- [ ] `agency --version` prints `agency v0.1.0 (commit <sha>)` in release binaries
- [ ] GitHub Release contains correct artifacts and checksums
- [ ] Archives contain `completions/agency.bash` and `completions/_agency`
- [ ] Homebrew formula pushed to `NielsdaWheelz/homebrew-tap`
- [ ] `brew install NielsdaWheelz/tap/agency` succeeds on clean macOS
- [ ] Bash and zsh completions installed automatically by brew
- [ ] Manual completion enablement works for tarball installs
- [ ] No regressions in existing functionality

---

## Verification Checklist (Manual)

### Pre-Release
- [ ] `goreleaser release --snapshot --skip=publish --clean` succeeds
- [ ] Snapshot archives contain `completions/` directory with both files
- [ ] Built binary reports correct version

### Post-Release
- [ ] Tag `v0.1.0` pushed
- [ ] GitHub Release created with binaries + archives
- [ ] Checksums.txt present and correct
- [ ] Homebrew formula auto-updated in tap repo

### macOS Verification
- [ ] `brew install NielsdaWheelz/tap/agency` succeeds
- [ ] `agency --version` prints correct version
- [ ] `agency <TAB>` shows completions (after shell restart)
- [ ] `agency doctor` succeeds

### Linux Verification
- [ ] Download tarball from GitHub Releases
- [ ] Extract and run `./agency --version`
- [ ] Manual completion enablement:
  ```bash
  ./agency completion bash > ~/.agency-completion.bash
  source ~/.agency-completion.bash
  ```
- [ ] Completions work after sourcing
