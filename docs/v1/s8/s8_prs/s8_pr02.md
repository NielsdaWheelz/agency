# Slice 8 — PR-02: Sandbox Creation + Invocation Records

## Purpose

Introduce **per-invocation sandbox worktrees** and **canonical invocation records**, enabling multiple agents to run concurrently against a single integration worktree **without ever touching it directly**.

This PR establishes the physical isolation model. No runners execute yet.

---

## Invariants (Hard Requirements)

These invariants are introduced in PR-02 and must hold for all later PRs:

1. **Integration worktrees are never modified by agents**
2. **Every agent invocation gets its own sandbox worktree**
3. **No sandbox may ever resolve to an integration tree path**
4. **If sandbox creation fails, invocation creation must abort**
5. **No fallback execution paths exist**
6. **All state is inspectable on disk**

These invariants are enforced by code and tests in this PR.

---

## Scope

### In Scope

- Invocation identity and metadata
- Sandbox branch + worktree creation
- Integration marker enforcement
- Invocation resolution (ID / prefix)
- Failure-safe creation + cleanup
- Tests for invariant enforcement

### Explicitly Out of Scope

- Runner execution (headed or headless)
- Logging
- Checkpointing
- Landing / diff / discard
- Watch UI

---

## Data Model

### Invocation Meta (Canonical Record)

Location:

```
${DATA_DIR}/repos/<repo_id>/invocations/<invocation_id>/meta.json
```

Schema:

```json
{
  "schema_version": "1.0",
  "invocation_id": "20260128120500-b7c9",
  "invocation_name": "arch-agent",
  "integration_worktree_id": "20260128120000-a3f2",
  "sandbox_path": "/abs/path/to/sandboxes/20260128120500-b7c9/tree",
  "sandbox_branch": "agency/sandbox-20260128120500-b7c9",
  "base_commit": "789abc...",
  "runner": "claude",
  "mode": "headed",
  "status": "starting",
  "started_at": "2026-01-28T12:05:00Z"
}
```

Notes:

- `status` is initialized to `starting`
- This file is the **single source of truth** for invocation + sandbox state

### Invocation Name Semantics

- `invocation_name` is **optional** (may be empty string or omitted)
- It is a human-facing label only — **not used for identity**
- Uniqueness is **not enforced** — two invocations named "test-agent" is fine
- The resolver **never matches on name** — resolution is by invocation ID or prefix only
- Display commands (`agent ls`, `agent show`) show the name if present, but it has no mechanical effect

---

## Sandbox Layout

Operational artifacts only (no meta):

```
${DATA_DIR}/repos/<repo_id>/sandboxes/<invocation_id>/
└── tree/
    ├── .git
    ├── .agency/
    │   └── SANDBOX_MARKER
    └── <project files>
```

### SANDBOX_MARKER

Path:

```
<sandbox_tree>/.agency/SANDBOX_MARKER
```

Contents:

```
# This directory is a sandbox worktree.
# Runners may execute here.
```

Purpose:

- Dual-marker protection against path confusion
- Later PRs must assert sandbox marker before execution

---

## Branching Model

- **Integration branch:** `agency/<name>-<shortid>` (already exists)
- **Sandbox branch:** `agency/sandbox-<invocation_id>` (full ID)

Rules:

- One sandbox branch per invocation
- Sandbox branches are ephemeral
- Deleted on discard / land / failed creation cleanup

---

## Command Behavior

### `agency agent start`

This PR implements **creation only**, not execution.

#### Pre-Lock Steps

1. Resolve integration worktree (name / id / prefix)
2. Verify integration marker exists — if missing, abort
3. Generate `invocation_id`
4. Resolve `repoRoot` (via repo index if needed — CWD may not be inside the integration tree)

#### Sandbox Path Safety Check

After computing `sandbox_tree_path` but **before** `git worktree add`, reject if:

- Path equals the integration tree path
- Path is a parent or child of the integration tree path
- Path contains `.agency/INTEGRATION_MARKER` (defensive check)

This closes a class of path computation bugs before any git state is modified.

#### Creation Steps (Under Lock)

5. Acquire repo lock
6. `EnsureInvocationDir()` — exclusive `os.Mkdir` for `invocations/<id>/`
7. Capture `base_commit`:
   ```bash
   git rev-parse <integration_branch>
   ```
8. Create sandbox branch + worktree:
   ```bash
   git -C <repoRoot> worktree add \
     -b agency/sandbox-<invocation_id> \
     <sandbox_tree_path> \
     <integration_branch>
   ```
9. Write `.agency/SANDBOX_MARKER`
10. Write `invocations/<id>/meta.json` atomically
11. Release repo lock

**Directory creation ordering rationale:** Invocation dir is created before the sandbox worktree (step 6 before step 8). If invocation dir exists but sandbox creation fails, both can be reliably cleaned up. If sandbox exists but invocation dir doesn't, you risk orphaned sandboxes with no metadata pointing to them.

#### Commit Point

Sandbox creation is considered **successful only after all three**:

- `git worktree add` completed
- `SANDBOX_MARKER` written
- Invocation `meta.json` written

Before the commit point, all state is rollbackable. After, the invocation is observable to other commands.

#### Lock Scope

Repo lock is held **only** during:

- `git worktree add`
- Marker and meta writes
- Rollback cleanup (if needed)

The lock is **never** held across user input or runner execution (future PRs must not widen this).

#### Failure Handling

If **any step after `git worktree add` fails**:

1. `git worktree remove --force <sandbox_tree_path>` (best effort)
2. `git branch -D <sandbox_branch>` (best effort)
3. Remove invocation directory if meta.json was not successfully written (best effort)
4. Release repo lock
5. Return the original error

All cleanup steps are best-effort: failure to clean is **logged** but creation still fails with the original error. Cleanup failure does not equal silent success.

**Never fall back to integration tree.**

---

## Store Additions

### New Paths

```go
Store.InvocationDir(repoID, invocationID)
Store.InvocationMetaPath(repoID, invocationID)

Store.SandboxDir(repoID, invocationID)
Store.SandboxTreePath(repoID, invocationID)
```

### New Helpers

| Helper | Description |
|---|---|
| `EnsureInvocationDir()` | Exclusive mkdir |
| `WriteInvocationMeta()` | Atomic JSON write |
| `UpdateInvocationMeta()` | Read-modify-write |
| `RemoveSandboxTree()` | Best-effort cleanup |

---

## Resolution

### Invocation Resolver

- Accepts:
  - Full invocation ID
  - Unique prefix
- **Does not match on invocation name** (names are UX sugar, not identity)
- Errors:
  - Not found
  - Ambiguous prefix

Implementation mirrors worktree resolver patterns from PR-01.

### Broken Invocation Detection

An invocation is **broken** if any of these hold:

- `meta.json` exists but sandbox tree directory is missing
- Sandbox tree exists but `meta.json` is missing or unparseable

Broken invocations:

- Marked with `broken=true` in scan results
- Listed by `agent ls --all` but **excluded** from default `agent ls` output
- Resolvable by exact ID (escape hatch, consistent with PR-01 worktree rules)
- **Not auto-repaired** in this PR — broken state is allowed to exist and be visible

This matters for long-lived repos and interrupted creation attempts.

---

## Integration Tree Protection (Mandatory Tests)

These tests must land in PR-02.

### Test: sandbox never resolves to integration tree

- Force sandbox path collision
- Assert `agent start` aborts
- Assert no invocation meta written

### Test: integration marker enforcement

- Attempt `agent start` targeting non-integration tree
- Expect hard failure

### Test: sandbox marker written

- After successful start, verify `.agency/SANDBOX_MARKER` exists
- Verify integration tree does **not** contain sandbox marker

### Test: cleanup on partial failure

Simulate:

- `git worktree add` succeeds
- Marker write fails

**Allowed simulation methods:**

- Fake FS implementation that returns error on `WriteFile` for the marker path
- Injected failure callback in the service layer
- Permission-based: make sandbox `.agency/` dir read-only after worktree creation

OS-level permission hacks (e.g., chown to root) are discouraged.

Assert:

- No sandbox worktree remains (`git worktree list` does not include it)
- No sandbox branch remains (`git branch --list` does not include it)
- No invocation meta exists (invocation dir is cleaned up)

---

## Non-Goals and Explicit Restraints

### Out of Scope

- No runner execution
- No tmux
- No subprocesses
- No logs
- No checkpoints
- No watch

This PR is about **structure and safety**, not activity.

### N1: Runner fields are inert

`runner`, `mode`, and `status` fields exist in meta.json but are **placeholders only**. No code in PR-02 should branch on their values. They are written at creation time and not read back by any logic in this PR. This prevents premature runner logic from leaking into the creation path.

### N2: No scaffold directories in sandbox

Resist the urge to create future directories (logs/, checkpoints/, etc.) during sandbox creation. Empty directories become "assumed invariants" that later code depends on without explicit creation.

Sandbox tree in PR-02 contains **only**:

- `.git` (created by `git worktree add`)
- `.agency/SANDBOX_MARKER` (created by PR-02)
- Project files (inherited from integration branch)

Nothing else.

### N3: No auto-repair logic

Broken state (missing meta, orphaned sandbox) is allowed to exist and be visible. This is deliberate — professional systems (git, Kubernetes, Docker) surface broken state for human inspection rather than silently repairing it. Auto-repair is a future concern, not a PR-02 concern.

---

## Acceptance Criteria

- [ ] Multiple sandboxes can be created per integration worktree
- [ ] Integration tree remains unchanged
- [ ] Invocation meta is canonical and complete
- [ ] Sandbox creation is atomic or rolled back
- [ ] Integration marker is enforced
- [ ] Sandbox marker is written
- [ ] All invariant tests pass

---

## Rationale

This PR establishes isolation by construction rather than locking or coordination.
All later complexity (runners, checkpoints, landing) builds on this foundation.

If PR-02 is correct, the rest of slice 8 is straightforward.
